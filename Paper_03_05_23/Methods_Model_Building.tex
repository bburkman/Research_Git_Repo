%%%
\subsection{Model Building}

To build our model we primarily used
 scikit-learn \citep{scikit-learn} and imbalanced-learn \citep{Imblearn}, and also
Keras/Tensorflow \citep{chollet2015keras} for the Focal Loss model.  

We will explain our methods with examples.  

The histogram below illustrates the kind of results we can realistically hope for in a good model.  The white boxes represent the 150,771 negative samples in the test set, and the black boxes the 26,621 positive samples.  The model evaluates each sample and gives it a probability $p \in (0,1)$ that the sample is in the positive class.  Ideally we want the model to  give most of the negative samples probabilities close to zero, and the positive samples probabilities close to one, but some will be hard to classify correctly.  The ROC curve below shows the median value of $p$ for the negative (0.338) and positive (0.658) classes.  If we choose $p=0.5$ as our threshold, we get the metrics shown.  

\noindent\begin{tabular}{@{}p{0.3\textwidth}@{\hspace{24pt}} p{0.3\textwidth} @{\hspace{24pt}} p{0.3\textwidth}}
  \vspace{0pt} \input{../Keras/Images/Ideal_Pred.pgf}
  &
  \vspace{0pt} \input{../Keras/Images/Ideal_ROC.pgf}
  &
\vspace{0pt} 
  
\begin{tabular}{cc|c|c|}
	&\multicolumn{1}{c}{}& \multicolumn{2}{c}{Prediction} \cr
	&\multicolumn{1}{c}{} & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{P} \cr\cline{3-4}
	\multirow{2}{*}{\rotatebox[origin=c]{90}{Actual}}&N & 117,929 & 32,842 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
	&P & 5,928 & 20,693 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
\end{tabular}

\begin{center}
\begin{tabular}{ll}
0.387 & Precision \cr 
0.777 & Recall \cr 
0.516 & F1 \cr 
\end{tabular}
\end{center}
  
\end{tabular}

Note that with threshold $p=0.5$ the false positives ($FP=32,842$) are less than twice as many as the true positives ($TP=20,693$), but that does not satisfy our requirement that $\Delta FP/\Delta TP < 2.0$.  The plot below shows the rate of change as a function of $p$, and that $\Delta FP/\Delta TP = 2.0$ when $p=0.635$.  

\input{../Keras/Images/Ideal_Shift_to_FP_equals_r_TP_FP_TP.pgf}

We want $p=0.635$ to be our threshold while still using tools that assume $p=0.5$ is the threshold, so we will linearly transform the probabilities, mapping $0.635 \to 0.5$ while keeping 0.0 at 0.0, shown below in Example 2. Note that the linear transformation of the probabilities has no affect on the shape of the ROC curve nor the area under it.  The 0.243 and 0.52 are the median transformed probabilities for the negative and positive classes, respectively.  

\noindent\begin{tabular}{@{}p{0.3\textwidth}@{\hspace{24pt}} p{0.3\textwidth} @{\hspace{24pt}} p{0.3\textwidth}}
  \vspace{0pt} \input{../Keras/Images/Ideal_Shift_to_FP_equals_r_TP_Pred.pgf}
  &
  \vspace{0pt} \input{../Keras/Images/Ideal_Shift_to_FP_equals_r_TP_ROC.pgf}
  &
\vspace{0pt} 
  
\begin{tabular}{cc|c|c|}
	&\multicolumn{1}{c}{}& \multicolumn{2}{c}{Prediction} \cr
	&\multicolumn{1}{c}{} & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{P} \cr\cline{3-4}
	\multirow{2}{*}{\rotatebox[origin=c]{90}{Actual}}&N & 136,348 & 14,423 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
	&P & 12,017 & 14,604 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
\end{tabular}

\begin{center}
\begin{tabular}{ll}
0.503 & Precision \cr 
0.549 & Recall \cr 
0.525 & F1 \cr 
\end{tabular}
\end{center}
  
\end{tabular}

We have decided that we want $\Delta FP/\Delta TP < 2.0$; we had $FP/TP < 2.0$, and now have $FP/TP \approx 1$, sending fewer ambulances to crashes that need one.  Why is this better?  If we look at the change in FP and TP from changing the threshold $p = 0.5 \to 0.635$, 

$$\frac{\Delta FP}{\Delta TP} = \frac{32,842 - 14,423}{20,693-14,604} = \frac{18,419}{6,089} \approx 3$$

By changing the threshold, we have not sent some ambulances that were needed, but have not sent three times as many ambulances that were not needed.  Given our goal of $\Delta FP/\Delta TP < 2$, this tradeoff is appropriate.  

It sometimes happens that, using $p=0.5$, a model will recommend that we never send an ambulance, as in Example 3 below, which is a linear transformation of Example 1, $f(x) = 0.5x$.  (One cause of such a model is the class weight being too low.) Such a model can still be useful if it separates the negative and positive classes well, because we can move the threshold.   


\noindent\begin{tabular}{@{}p{0.3\textwidth}@{\hspace{24pt}} p{0.3\textwidth} @{\hspace{24pt}} p{0.3\textwidth}}
  \vspace{0pt} \input{../Keras/Images/Ideal_Left_Pred.pgf}
%  &
%  \vspace{0pt} \input{../Keras/Images/Ideal_Left_ROC.pgf}
  &
\vspace{0pt} 
  
\begin{tabular}{cc|c|c|}
	&\multicolumn{1}{c}{}& \multicolumn{2}{c}{Prediction} \cr
	&\multicolumn{1}{c}{} & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{P} \cr\cline{3-4}
	\multirow{2}{*}{\rotatebox[origin=c]{90}{Actual}}&N & 150,771    &  0 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
	&P & 22,621 & 0 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
\end{tabular}

\begin{center}
\begin{tabular}{ll}
und & Precision \cr 
0.000 & Recall \cr 
und & F1 \cr 
\end{tabular}
\end{center}
  
\end{tabular}

Similarly, if the class weight is too high, we may get a model like Example 4 that sends an ambulance to every reported crash.  Example 4 is Example 1 transformed with $f(x) = 0.5x + 0.5$

\noindent\begin{tabular}{@{}p{0.3\textwidth}@{\hspace{24pt}} p{0.3\textwidth} @{\hspace{24pt}} p{0.3\textwidth}}
  \vspace{0pt} \input{../Keras/Images/Ideal_Right_Pred.pgf}
%  &
%  \vspace{0pt} \input{../Keras/Images/Ideal_Left_ROC.pgf}
  &
\vspace{0pt} 
  
\begin{tabular}{cc|c|c|}
	&\multicolumn{1}{c}{}& \multicolumn{2}{c}{Prediction} \cr
	&\multicolumn{1}{c}{} & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{P} \cr\cline{3-4}
	\multirow{2}{*}{\rotatebox[origin=c]{90}{Actual}}&N & 0 & 150,771   \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
	&P & 0 & 22,621 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
\end{tabular}

\begin{center}
\begin{tabular}{ll}
0.150 & Precision \cr 
1.000 & Recall \cr 
0.261 & F1 \cr 
\end{tabular}
\end{center}
  
\end{tabular}

Some models, like the Easy Ensemble Classifier and RUSBoost, give a tight range of probabilities.  Example 5 below is the probabilities from Example 1 linearly transformed with $f(x) = 0.2x + 0.4$ to have range $p \in [0,4,0.6]$.  As a model it gives the same decisions and metrics as Example 1, but is not as useful as a data visualization for comparing models, which is why we dilate the probabilities to go to $p=0.0$.

\noindent\begin{tabular}{@{}p{0.3\textwidth}@{\hspace{24pt}} p{0.3\textwidth} @{\hspace{24pt}} p{0.3\textwidth}}
  \vspace{0pt} \input{../Keras/Images/Ideal_Tight_Pred.pgf}
%  &
%  \vspace{0pt} \input{../Keras/Images/Ideal_Left_ROC.pgf}
  &
\vspace{0pt} 
  
\begin{tabular}{cc|c|c|}
	&\multicolumn{1}{c}{}& \multicolumn{2}{c}{Prediction} \cr
	&\multicolumn{1}{c}{} & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{P} \cr\cline{3-4}
	\multirow{2}{*}{\rotatebox[origin=c]{90}{Actual}}&N & 117,929 & 32,842 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
	&P & 5,928 & 20,693 \vrule width 0pt height 10pt depth 2pt \cr\cline{3-4}
\end{tabular}

\begin{center}
\begin{tabular}{ll}
0.387 & Precision \cr 
0.777 & Recall \cr 
0.516 & F1 \cr 
\end{tabular}
\end{center}
  
\end{tabular}

Because Examples 3, 4, and 5 are linear transformations of Example 1, when we find the value of decision threshold $p$ that makes $\Delta FP/\Delta TP = 2.0$ and linearly transform the probabilities, each of them becomes the distribution in Example 2.  


